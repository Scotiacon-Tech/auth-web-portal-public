import{_ as U}from"./BeqOl9vv.js";import{A as T,u as C,m as q,r as _,B as z,s as f,o as k,p as x,w as r,z as N,b as l,a as m,t as I,d as D,D as M}from"./BGiLZV0E.js";import{u as $,V as O}from"./C-i1CYz_.js";import{O as J,a as H,V as Y,b as j}from"./DLyoCXn1.js";import{T as F}from"./BwMHTV5E.js";import{b as G,V as S,a as R}from"./CL1lDOKn.js";import"./Vbk6cZl4.js";const K="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";function Q(u=16,o=K){let t="",e=u;const a=o.length;for(;e--;)t+=o[Math.random()*a|0];return t}const W=()=>({getState:(t=!1)=>{const e=T(),a=window.localStorage;let n=a.getItem("state");return!n&&t&&(n=Q(32),a.setItem("state",n)),{store:n||"",query:(e.currentRoute.value.query.state||"").toString()}},clearState:()=>{window.localStorage.removeItem("state")}}),X=()=>(T().currentRoute.value.query.code||"").toString(),Z=async()=>{const u=C();try{const o=await $fetch(`${u.public.issuerUri}/.well-known/openid-configuration`,{method:"get",parseResponse:e=>e}),t=new J;return t.parseJSON(o),t}catch(o){throw o}},ee=async u=>{const o=C(),t=$();let e="";const a=new URL(t.href),n=[];for(const c of a.searchParams.keys())n.push(c);n.forEach(c=>{a.searchParams.delete(c)});try{const c=await $fetch(`${o.public.issuerUri}/api/login`,{method:"post",body:{code:u,redirect_uri:a.href},parseResponse:w=>(e=w,w)}),h=new H;return h.parseJSON(e),h}catch{throw JSON.parse(e)}},te={class:"text-center"},re={class:"text-center",style:{left:"-28px",position:"relative"}},de=q({__name:"index",async setup(u){let o,t;const e=_(!0),a=C(),n=T(),c=F.getInstance(),h=c.getTokenByService("graze");h&&c.accessTimeRemaining(h)>0&&(e.value=!1,n.push("/admin/dashboard"));const w=$(),{getState:b,clearState:oe}=W();let V=X(),d=b();const g=_(""),y=_(),A=_(),v=_(),p=new URL(w.href),P=[],L=async()=>{if(d.query!==""&&d.query===d.store)if(!V)d=b(!0);else try{const i=await ee(V),s=new URL(A.value);s.pathname="/api/refresh",c.addToken({OAuthToken:i,OAuthConfig:v.value,Vendor:"internal",Endpoint:s.href,Expires:new Date(Date.now()+i.ExpiresIn*1e3).getTime(),Method:"header",Header:"Authorization",HeaderPrefix:"Bearer ",Service:"graze",Timer:void 0}),console.log("Proceed with Login"),e.value=!1,n.push("/admin/dashboard")}catch{g.value="Error encountered during login"}else d.store||(d=b(!0));e.value&&!g.value&&(p.searchParams.get("error")==="access_denied"&&p.searchParams.get("error_description")!==""?(e.value=!0,g.value=p.searchParams.get("error_description")||""):y.value&&(e.value=!1,p.searchParams.delete("state"),M(`${y.value}?response_type=code&client_id=internal&redirect_uri=${encodeURIComponent(p.href)}&state=${d.store}`,{external:!0})));for(const i of p.searchParams.keys())P.push(i);P.forEach(i=>{p.searchParams.delete(i)})},E=async()=>{try{v.value=await Z(),y.value=v.value.AuthorizationEndpoint,A.value=v.value.TokenEndpoint,L()}catch(i){console.error(i),setTimeout(()=>{E().then(()=>{L()}).catch(s=>{console.error(s)})},1e4)}};return[o,t]=z(()=>E()),await o,t(),(i,s)=>{const B=U;return f(e)?(k(),x(G,{key:0},{default:r(()=>[l(R,null,{default:r(()=>[l(S,null,{default:r(()=>[m("h1",te,I(f(a).public.organisationName),1)]),_:1})]),_:1}),l(R,null,{default:r(()=>[l(S,null,{default:r(()=>[f(g)?(k(),x(O,{key:0,text:f(g),type:"error",style:{"max-width":"450px"},class:"ma-auto"},null,8,["text"])):N("",!0)]),_:1})]),_:1}),l(R,null,{default:r(()=>[f(y)?(k(),x(S,{key:0,class:"text-center"},{default:r(()=>[l(B,{href:`${f(y)}?response_type=code&client_id=internal&redirect_uri=${f(p).href}&state=${f(d).store}`},{default:r(()=>[l(Y,{color:"primary"},{default:r(()=>s[0]||(s[0]=[D("Login")])),_:1})]),_:1},8,["href"])]),_:1})):(k(),x(S,{key:1},{default:r(()=>[l(O,{icon:"mdi:mdi-alert",style:{"max-width":"450px"},class:"ma-auto",color:"red"},{title:r(()=>s[1]||(s[1]=[m("p",null," Server Error ",-1)])),text:r(()=>s[2]||(s[2]=[m("p",{class:"mb-4"}," The service is currently down. ",-1),m("p",{class:"mb-4"}," This page will automatically become operational as soon as possible. ",-1),m("p",{class:"mb-4"}," You do not need to refresh. ",-1)])),default:r(()=>[m("p",re,[l(j,{size:60,width:7,indeterminate:""})])]),_:1})]),_:1}))]),_:1})]),_:1})):N("",!0)}}});export{de as default};
