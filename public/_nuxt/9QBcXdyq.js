import{_ as B}from"./GAjx2JXJ.js";import{D as C,u as T,m as I,r as _,B as q,s as m,o as k,p as x,w as r,z as N,b as u,a as f,t as z,d as D,A as M}from"./ZZYALxJR.js";import{u as $,V as O}from"./fdAtb9Mf.js";import{O as J,a as H,V as Y,b as j}from"./Bir1xsaG.js";import{T as F}from"./BZenHhyw.js";import{V as G}from"./BlIfG-F7.js";import{V as S,a as b}from"./BTRniZtP.js";import"./CkFgYFQi.js";import"./B0tRseua.js";/* empty css        */const K="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";function Q(d=16,o=K){let t="",e=d;const a=o.length;for(;e--;)t+=o[Math.random()*a|0];return t}const W=()=>({getState:(t=!1)=>{const e=C(),a=window.localStorage;let n=a.getItem("state");return!n&&t&&(n=Q(32),a.setItem("state",n)),{store:n||"",query:(e.currentRoute.value.query.state||"").toString()}},clearState:()=>{window.localStorage.removeItem("state")}}),X=()=>(C().currentRoute.value.query.code||"").toString(),Z=async()=>{const d=T();try{const o=await $fetch(`${d.public.issuerUri}/.well-known/openid-configuration`,{method:"get",parseResponse:e=>e}),t=new J;return t.parseJSON(o),t}catch(o){throw o}},ee=async d=>{const o=T(),t=$();let e="";const a=new URL(t.href),n=[];for(const c of a.searchParams.keys())n.push(c);n.forEach(c=>{a.searchParams.delete(c)});try{const c=await $fetch(`${o.public.issuerUri}/api/login`,{method:"post",body:{code:d,redirect_uri:a.href},parseResponse:w=>(e=w,w)}),h=new H;return h.parseJSON(e),h}catch{throw JSON.parse(e)}},te={class:"text-center"},re={class:"text-center",style:{left:"-28px",position:"relative"}},fe=I({__name:"index",async setup(d){let o,t;const e=_(!0),a=T(),n=C(),c=F.getInstance(),h=c.getTokenByService("graze");h&&c.accessTimeRemaining(h)>0&&(e.value=!1,n.push("/admin/dashboard"));const w=$(),{getState:R,clearState:oe}=W();let V=X(),p=R();const g=_(""),y=_(),A=_(),v=_(),l=new URL(w.href),P=[],L=async()=>{if(p.query!==""&&p.query===p.store)if(!V)p=R(!0);else try{const i=await ee(V),s=new URL(A.value);s.pathname="/api/refresh",c.addToken({OAuthToken:i,OAuthConfig:v.value,Vendor:"internal",Endpoint:s.href,Expires:new Date(Date.now()+i.ExpiresIn*1e3).getTime(),Method:"header",Header:"Authorization",HeaderPrefix:"Bearer ",Service:"graze",Timer:void 0}),e.value=!1,n.push("/admin/dashboard")}catch{g.value="Error encountered during login"}else p.store||(p=R(!0));e.value&&!g.value&&(l.searchParams.get("error")==="access_denied"&&l.searchParams.get("error_description")!==""?(e.value=!0,g.value=l.searchParams.get("error_description")||""):y.value&&(e.value=!1,l.searchParams.delete("code"),l.searchParams.delete("state"),M(`${y.value}?response_type=code&client_id=internal&redirect_uri=${encodeURIComponent(l.href)}&state=${p.store}`,{external:!0})));for(const i of l.searchParams.keys())P.push(i);P.forEach(i=>{l.searchParams.delete(i)})},E=async()=>{try{v.value=await Z(),y.value=v.value.AuthorizationEndpoint,A.value=v.value.TokenEndpoint,L()}catch(i){console.error(i),setTimeout(()=>{E().then(()=>{L()}).catch(s=>{console.error(s)})},1e4)}};return[o,t]=q(()=>E()),await o,t(),(i,s)=>{const U=B;return m(e)?(k(),x(G,{key:0},{default:r(()=>[u(b,null,{default:r(()=>[u(S,null,{default:r(()=>[f("h1",te,z(m(a).public.organisationName),1)]),_:1})]),_:1}),u(b,null,{default:r(()=>[u(S,null,{default:r(()=>[m(g)?(k(),x(O,{key:0,text:m(g),type:"error",style:{"max-width":"450px"},class:"ma-auto"},null,8,["text"])):N("",!0)]),_:1})]),_:1}),u(b,null,{default:r(()=>[m(y)?(k(),x(S,{key:0,class:"text-center"},{default:r(()=>[u(U,{href:`${m(y)}?response_type=code&client_id=internal&redirect_uri=${encodeURIComponent(m(l).href)}&state=${m(p).store}`},{default:r(()=>[u(Y,{color:"primary"},{default:r(()=>s[0]||(s[0]=[D("Login")])),_:1})]),_:1},8,["href"])]),_:1})):(k(),x(S,{key:1},{default:r(()=>[u(O,{icon:"mdi:mdi-alert",style:{"max-width":"450px"},class:"ma-auto",color:"red"},{title:r(()=>s[1]||(s[1]=[f("p",null," Server Error ",-1)])),text:r(()=>s[2]||(s[2]=[f("p",{class:"mb-4"}," The service is currently down. ",-1),f("p",{class:"mb-4"}," This page will automatically become operational as soon as possible. ",-1),f("p",{class:"mb-4"}," You do not need to refresh. ",-1)])),default:r(()=>[f("p",re,[u(j,{size:60,width:7,indeterminate:""})])]),_:1})]),_:1}))]),_:1})]),_:1})):N("",!0)}}});export{fe as default};
