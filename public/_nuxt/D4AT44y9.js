import{_ as S}from"./ChVKsPDX.js";import{aa as A,a0 as L,T as $,r as g,a9 as b,V as i,o as C,Y as T,w as a,X as P,a8 as O,b as n,a as U,t as B,d as D}from"./CAOQfWXx.js";import{u as E}from"./DGmwcfIz.js";import{u as q}from"./BH8WfetY.js";import{u as z}from"./seZSGpOe.js";import{T as I}from"./A4W5cgAN.js";import{O as M}from"./lKELra2E.js";import{V as H}from"./BGUAx3Eu.js";import{a as x,V as w}from"./8jOmeCJr.js";import{V as J}from"./BKhpz2_P.js";import{v as X}from"./BpP4Qw09.js";import"./B5CZD0j7.js";import"./PLM72-m0.js";const Y=()=>(A().currentRoute.value.query.code||"").toString(),j=async y=>{const u=L(),f=E();let e="";const c=new URL(f.href),l=[];for(const r of c.searchParams.keys())l.push(r);l.forEach(r=>{c.searchParams.delete(r)});try{const r=await $fetch(`${u.public.issuerUri}/api/login`,{method:"post",body:{code:y,redirect_uri:c.href},parseResponse:h=>(e=h,h)}),d=new M;return d.parseJSON(e),d}catch{throw JSON.parse(e)}},F={class:"text-center"},ce=$({__name:"index",async setup(y){let u,f;const e=g(!0),c=L(),l=A(),r=I.getInstance(),d=r.getTokenByService("graze");d&&r.accessTimeRemaining(d)>0&&(e.value=!1,l.push("/admin/dashboard"));const h=E(),{getState:v}=q();let R=Y(),s=v();const p=g(""),k=g(""),_=g();try{_.value=([u,f]=b(()=>z()),u=await u,f(),u),k.value=_.value.AuthorizationEndpoint}catch(t){console.error(t)}const o=new URL(h.href),V=[];return(async()=>{if(s.query!==""&&s.query===s.store)if(!R)s=v(!0);else try{const t=await j(R),m=new URL(_.value.TokenEndpoint);m.pathname="/api/refresh",r.addToken({OAuthToken:t,OAuthConfig:_.value,Vendor:"internal",Endpoint:m.href,Expires:new Date(Date.now()+t.ExpiresIn*1e3).getTime(),Method:"header",Header:"Authorization",HeaderPrefix:"Bearer ",Service:"graze",Timer:void 0}),e.value=!1,l.push("/admin/dashboard")}catch{p.value="Error encountered during login"}else s.store||(s=v(!0));e.value&&!p.value&&(o.searchParams.get("error")==="access_denied"&&o.searchParams.get("error_description")!==""?(e.value=!0,p.value=o.searchParams.get("error_description")||""):(e.value=!1,o.searchParams.delete("code"),o.searchParams.delete("state"),O(`${k.value}?response_type=code&client_id=internal&redirect_uri=${encodeURIComponent(o.href)}&state=${s.store}`,{external:!0})));for(const t of o.searchParams.keys())V.push(t);V.forEach(t=>{o.searchParams.delete(t)})})(),(t,m)=>{const N=S;return i(e)?(C(),T(H,{key:0},{default:a(()=>[n(w,null,{default:a(()=>[n(x,null,{default:a(()=>[U("h1",F,B(i(c).public.organisationName),1)]),_:1})]),_:1}),n(w,null,{default:a(()=>[n(x,null,{default:a(()=>[i(p)?(C(),T(J,{key:0,text:i(p),type:"error",style:{"max-width":"450px"},class:"ma-auto"},null,8,["text"])):P("",!0)]),_:1})]),_:1}),n(w,null,{default:a(()=>[n(x,{class:"text-center"},{default:a(()=>[n(N,{href:`${i(k)}?response_type=code&client_id=internal&redirect_uri=${encodeURIComponent(i(o).href)}&state=${i(s).store}`},{default:a(()=>[n(X,{color:"primary"},{default:a(()=>m[0]||(m[0]=[D("Login")])),_:1})]),_:1},8,["href"])]),_:1})]),_:1})]),_:1})):P("",!0)}}});export{ce as default};
